function onAppReady() {
    /*
    if( navigator.splashscreen && navigator.splashscreen.hide ) {   // Cordova API detected
        navigator.splashscreen.hide() ;
    }
    */
}
document.addEventListener("deviceready", onAppReady, false) ;

var MAX_ITEMS = 15;
var data = [];
var dataURL = "";
var baseURL = "";
var lang = "";

function getWebRoot() {
    "use strict";
    var path = window.location.href;
    path = path.substring( 0, path.lastIndexOf('/') );
    return path;
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function sanitizeWord(str) {
    return str.replace(/[^a-zA-Zа-яА-Я]/gi, '');
}

function highlightMeaning(str, dict) {
    var tag = 'b';
    if (dict == "en-bg")
        return str.replace(/([a-zA-Z '/-]{3,})/gi, '<em><b>$1</b></em>');
    else
        return str.replace(/([а-яА-Я '/-]{3,})/gi, '<em><b>$1</b></em>');
}

function initApp() {
    baseURL = getWebRoot();
}

function getDict(input) {
    if (!input) {
        return;
    }
    var char = S(input).left(1).toLowerCase();

    var dict = "";
    if (char.match(/[a-zA-z]/i)) {
        dict = "en-bg";
    }
    else if (char.match(/[а-яА-Я]/i)) {
        dict = "bg-en";
    }
    return dict;
}

function getLetterURL(input) {
    if (!input) {
        return;
    }
    var char = S(input).left(1).toLowerCase();

    var dict = getDict(input);
    if (!dict) {
        return;
    }
    
    var offset = 0;
    if (dict == "en-bg") {
        offset = 96;
    }
    else if (dict == "bg-en") {
        offset = 1071;
    }
    var dictURL = baseURL + "/data/" + dict;

    var code = char.charCodeAt(0);
    var order = code - offset;
    var letterURL = dictURL + "/d" + S(order).padLeft(2, "0") + ".json";
    return letterURL;
}

function findItem(input) {
    var index = -1;
    for (var i = 0; i < data.length; i++) {
        if (data[i].w && (S(data[i].w).startsWith(input))) {
            index = i;
            break;
        }
    }
    return index;
}

function loadList(index) {
    var $list = $("#word-list");
    var $pages = $("#pages");
    var input = $("#word-search").val();
    var dict = getDict(input);
    
    if (index < 0) {
        return;
    }
    
    var num = 0;
    for (var i = index; i < index + MAX_ITEMS; i++)
    {
        num++;
        
        var word = data[i].w;
        var transcript = (data[i].t)
            ? '<hr><p class="caption transcript"><span>Pronunciation: </span>' +
              escapeHtml(data[i].t) +
              '</p>'
            : '';
        var firstLine = (data[i].m) ? S(data[i].m).split('\r\n', 1)[0] : "";
        var meaning = escapeHtml(data[i].m);
        var body = highlightMeaning(meaning, dict);
        body = S(body).replaceAll("\r\n", "<br>");
        var wordID = sanitizeWord(word) + "-" + num + "-" + Math.floor(Math.random() * 65534) + 1;
        
        $list.append('<li><a href="#' + wordID + '"><span class="definition">' + escapeHtml(word) + '</span><br><span class="first-meaning">' + escapeHtml(firstLine) + '</span></a></li>');
        
        $pages.append(
        '<div class="panel details" data-title="' + escapeHtml(word) + '" id="' + wordID + '" data-footer="none">' +
        '    <p class="caption word"><span>Word: </span>' + escapeHtml(word) + '</p>' +
        transcript +
        '    <hr> ' +
        '    <p class="caption meaning"><span>Meaning:<br></span>' + body + '</p>' +
        '</div>'
        );
    }
}

function clearWords() {
    $("#word-list").empty();
    $(".pages .details").empty();
}

function loadWords(input) {
    if (!input) {
        return;
    }
    
    if ((!data) || (data.length === 0)) {
        return;
    }
    
    var index = -1;
    var count = 0;
    do {
        index = findItem(input);
        if (index < 0) {
            if (input.length > 0)
                input = S(input).left(input.length - 1);
            else
                input = "";
        }
        
        count++;
    } while ((index < 0) && (input !== "") && (count < 10));
    
    if (count >= 10) {
        index = -1;
    }
    
    loadList(index);
}

function loadData(url) {
    $.getJSON(url, function(json) {
        data = json;
        dataURL = url;
        
        var input = $("#word-search").val();
        
        loadWords(input);
    });
}

function checkLoadData(url) {
    if (dataURL != url) {
        loadData(url);
        return false;
    }
    
    return true;
}

function inputChanged() {
    var input = $("#word-search").val();
    var letterURL = getLetterURL(input);
    
    clearWords();

    if (checkLoadData(letterURL)) {
        loadWords(input);
    }
}

// The app.Ready event shown above is generated by the init-dev.js file; it
// unifies a variety of common "ready" events. See the init-dev.js file for
// more details. You can use a different event to start your app, instead of
// this event. A few examples are shown in the sample code above. If you are
// using Cordova plugins you need to either use this app.Ready event or the
// standard Crordova deviceready event. Others will either not work or will
// work poorly.

// NOTE: change "dev.LOG" in "init-dev.js" to "true" to enable some console.log
// messages that can help you debug Cordova app initialization issues.
